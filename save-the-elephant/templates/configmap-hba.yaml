{{- if .Values.postgresql.hba.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "save-the-elephant.fullname" . }}-hba
  labels:
    {{- include "save-the-elephant.labels" . | nindent 4 }}
data:
  00-setup-hba.sh: |
    #!/bin/bash
    set -e

    echo "Configuring pg_hba.conf for authentication mode: {{ .Values.postgresql.hba.authMode }}"

    # Create custom pg_hba.conf
    {
      echo "# PostgreSQL Host-Based Authentication Configuration"
      echo "# Generated by Helm chart"
      echo ""
      echo "# TYPE  DATABASE        USER            ADDRESS                 METHOD"
      echo ""
      echo "# Local connections (Unix socket) - always trust for pod-internal operations"
      echo "local   all             all                                     trust"
      echo ""
      echo "# IPv4 local connections"
      echo "host    all             all             127.0.0.1/32            {{ if eq .Values.postgresql.hba.authMode "password" }}scram-sha-256{{ else }}trust{{ end }}"
      echo ""
      echo "# IPv6 local connections"
      echo "host    all             all             ::1/128                 {{ if eq .Values.postgresql.hba.authMode "password" }}scram-sha-256{{ else }}trust{{ end }}"
{{- if .Values.replication.enabled }}
      echo ""
      echo "# Replication connections"
      echo "host    replication     {{ .Values.postgresql.auth.replicationUsername }}     0.0.0.0/0               {{ if eq .Values.postgresql.hba.authMode "password" }}scram-sha-256{{ else }}trust{{ end }}"
      echo "host    replication     {{ .Values.postgresql.auth.replicationUsername }}     ::0/0                   {{ if eq .Values.postgresql.hba.authMode "password" }}scram-sha-256{{ else }}trust{{ end }}"
{{- end }}
      echo ""
      echo "# All other network connections"
      echo "host    all             all             0.0.0.0/0               {{ if eq .Values.postgresql.hba.authMode "password" }}scram-sha-256{{ else }}trust{{ end }}"
      echo "host    all             all             ::0/0                   {{ if eq .Values.postgresql.hba.authMode "password" }}scram-sha-256{{ else }}trust{{ end }}"
    } > "$PGDATA/pg_hba.conf"

    echo "pg_hba.conf configuration complete"
{{- end }}
